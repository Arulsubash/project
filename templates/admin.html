{% extends "layout.html" %}
{% block body %}
<div id="root" style="background-color: #f9fafb; padding: 0px; height: auto;">
    <div class="d-flex p-2" id="nav-bar">
        <div>
            <h1 id="headline">CampusCare</h1>
            <button id="button-admin" style="background-color: #EF4444; color: white; border: none; border-radius: 10px;">Administrator</button>
        </div>
        <div class="d-flex align-items-center gap-3">
            <!-- User Icon -->
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-decoration-none" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle fs-4" id="user" style="padding: 7px 12px; border-radius: 8px; color: black"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#adminProfileModal">Profile</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/email-notifications">Email Notifications</a></li>
                <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Content -->
    <div id="home-content">
        <div id="request-title" class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>All Service Requests</h2>
                <p>Manage and assign campus service requests</p>
            </div>
            <div>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addWorkerModal">
                    <i class="bi bi-person-plus"></i> Add Worker
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card" style="background-color: #FFFBEB;">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ total_requests }}</h5>
                        <p class="card-text">Total Requests</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card" style="background-color: #EFF6FF;">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ pending_count }}</h5>
                        <p class="card-text">Pending Requests</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card" style="background-color: #F0FDF4;">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ resolved_count }}</h5>
                        <p class="card-text">Resolved Requests</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card" style="background-color: #FEF2F2;">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ workers|length }}</h5>
                        <p class="card-text">Total Workers</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="search-containner" class="mb-4">
            <span class="input-group-text" style="background-color: white; border-radius: 6px 0px 0px 6px; height:40px;">
                <i class="bi bi-search"></i>
            </span>
            <input id="input" type="text" placeholder="Search requests..." aria-label="Search">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center gap-2" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-funnel"></i>
                <span id="selected-filter">All</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                <li><h6 class="dropdown-header">Status</h6></li>
                <li><a class="dropdown-item filter-option" data-filter="all">All</a></li>
                <li><a class="dropdown-item filter-option" data-filter="pending">Pending</a></li>
                <li><a class="dropdown-item filter-option" data-filter="in-progress">In Progress</a></li>
                <li><a class="dropdown-item filter-option" data-filter="completed">Completed</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Priority</h6></li>
                <li><a class="dropdown-item filter-option" data-filter="low">Low Priority</a></li>
                <li><a class="dropdown-item filter-option" data-filter="medium">Medium Priority</a></li>
                <li><a class="dropdown-item filter-option" data-filter="high">High Priority</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Department</h6></li>
                <li><a class="dropdown-item filter-option" data-filter="all">All Departments</a></li>
                {% for department in departments %}
                <li><a class="dropdown-item filter-option" data-filter="{{ department|lower }}">{{ department }}</a></li>
                {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Requests Table -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Title</th>
                        <th scope="col">Student</th>
                        <th scope="col">Location</th>
                        <th scope="col">Department</th>
                        <th scope="col">Priority</th>
                        <th scope="col">Status</th>
                        <th scope="col">Date</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in all_requests %}
                    <tr>
                        <th scope="row">{{ request.id }}</th>
                        <td>{{ request.title }}</td>
                        <td>{{ request.student_name or "Unknown" }}</td>
                        <td>{{ request.location }}</td>
                        <td>{{ request.department or "Not assigned" }}</td>
                        <td>
                            <span class="badge
                                {% if request.priority == 'high' %}bg-danger
                                {% elif request.priority == 'medium' %}bg-warning
                                {% else %}bg-info{% endif %}">
                                {{ request.priority|capitalize }}
                            </span>
                        </td>
                        <td>
                            <span class="badge
                                {% if request.status == 'Completed' %}bg-success
                                {% elif request.status == 'In Progress' %}bg-primary
                                {% else %}bg-secondary{% endif %}">
                                {{ request.status }}
                            </span>
                        </td>
                        <td>{{ request.date }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#detailModal{{ request.id }}">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#assignModal{{ request.id }}">
                                <i class="bi bi-person-plus"></i>
                            </button>
                        </td>
                    </tr>

                    <!-- Detail Modal -->
                    <div class="modal fade" id="detailModal{{ request.id }}" tabindex="-1" aria-labelledby="detailModalLabel{{ request.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="detailModalLabel{{ request.id }}">Request Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <h6>{{ request.title }}</h6>
                                    <p><strong>Description:</strong> {{ request.description }}</p>
                                    <p><strong>Location:</strong> {{ request.location }}</p>
                                    <p><strong>Department:</strong> {{ request.department or "Not assigned" }}</p>
                                    <p><strong>Priority:</strong>
                                        <span class="badge
                                            {% if request.priority == 'high' %}bg-danger
                                            {% elif request.priority == 'medium' %}bg-warning
                                            {% else %}bg-info{% endif %}">
                                            {{ request.priority|capitalize }}
                                        </span>
                                    </p>
                                    <p><strong>Status:</strong>
                                        <span class="badge
                                            {% if request.status == 'Completed' %}bg-success
                                            {% elif request.status == 'In Progress' %}bg-primary
                                            {% else %}bg-secondary{% endif %}">
                                            {{ request.status }}
                                        </span>
                                    </p>
                                    <p><strong>Date Submitted:</strong> {{ request.date }}</p>
                                    <p><strong>Student:</strong> {{ request.student_name or "Unknown" }}</p>

                                    {% if request.workerID %}
                                        {% set worker = workers | selectattr("id", "equalto", request.workerID) | first %}
                                        <p><strong>Assigned To:</strong> {{ worker.username if worker else "Unknown" }}</p>
                                    {% endif %}

                                    {% if request.notes %}
                                        <p><strong>Notes:</strong> {{ request.notes }}</p>
                                    {% endif %}

                                    {% if request.image_path %}
                                        <p><strong>Attached Image:</strong></p>
                                        <img src="{{ url_for('static', filename='uploads/' + request.image_path) }}" class="img-fluid request-image" alt="Request image">
                                    {% endif %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Assign Modal -->
                    <div class="modal fade" id="assignModal{{ request.id }}" tabindex="-1" aria-labelledby="assignModalLabel{{ request.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="assignModalLabel{{ request.id }}">Assign Request</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form action="/assign-request" method="POST">
                                    <div class="modal-body">
                                        <input type="hidden" name="request_id" value="{{ request.id }}">
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="departmentSelect{{ request.id }}" class="form-label">Select Department</label>
                                                    <select class="form-select" id="departmentSelect{{ request.id }}" name="department" required onchange="loadWorkersByDepartment(this.value, {{ request.id }})">
                                                        <option value="">Select a department</option>
                                                        {% for department in departments %}
                                                        <option value="{{ department }}" {% if request.department == department %}selected{% endif %}>{{ department }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="workerSelect{{ request.id }}" class="form-label">Assign to Worker</label>
                                                    <select class="form-select" id="workerSelect{{ request.id }}" name="worker_id" required>
                                                        <option value="">Select a department first</option>
                                                    </select>
                                                    <div id="workerStatus{{ request.id }}" class="form-text"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="statusSelect{{ request.id }}" class="form-label">Update Status</label>
                                            <select class="form-select" id="statusSelect{{ request.id }}" name="status">
                                                <option value="Pending" {% if request.status == 'Pending' %}selected{% endif %}>Pending</option>
                                                <option value="In Progress" {% if request.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                                                <option value="Completed" {% if request.status == 'Completed' %}selected{% endif %}>Completed</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="notes{{ request.id }}" class="form-label">Notes (Optional)</label>
                                            <textarea class="form-control" id="notes{{ request.id }}" name="notes" rows="3">{{ request.notes or '' }}</textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Workers Table -->
    <div class="container mt-5">
        <h3>Workers Management</h3>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Name</th>
                        <th scope="col">Email</th>
                        <th scope="col">Department</th>
                        <th scope="col">Status</th>
                        <th scope="col">Assigned Tasks</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for worker in workers %}
                    <tr>
                        <th scope="row">{{ worker.id }}</th>
                        <td>{{ worker.username }}</td>
                        <td>{{ worker.email }}</td>
                        <td>{{ worker.department or "Not assigned" }}</td>
                        <td>
                            <span class="badge
                                {% if worker.status == 'Available' %}bg-success
                                {% else %}bg-warning{% endif %}">
                                {{ worker.status }}
                            </span>
                        </td>
                        <td>{{ worker.assigned_requests }}</td>
                        <td>
                            <form action="/delete-worker/{{ worker.id }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this worker?');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Worker Modal -->
    <div class="modal fade" id="addWorkerModal" tabindex="-1" aria-labelledby="addWorkerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addWorkerModalLabel">Add New Worker</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addWorkerForm" action="/add-worker" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="workerUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="workerUsername" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="workerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="workerEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="workerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="workerPassword" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="workerDepartment" class="form-label">Department</label>
                            <select class="form-select" id="workerDepartment" name="department" required>
                                <option value="" disabled selected>Select Department</option>
                                <option value="Electrical">Electrical</option>
                                <option value="Plumbing">Plumbing</option>
                                <option value="Carpentry">Carpentry</option>
                                <option value="HVAC">HVAC</option>
                                <option value="General Maintenance">General Maintenance</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Worker Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Profile Modal -->
    <div class="modal fade" id="adminProfileModal" tabindex="-1" aria-labelledby="adminProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminProfileModalLabel">Admin Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Name:</strong> {{ name }}</p>
                    <p><strong>Role:</strong> Administrator</p>
                    <hr>
                    <form method="POST" action="/reset-password">
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="new_password" required>
                        </div>
                        <button type="submit" class="btn btn-danger">Reset Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Search functionality for admin table
document.getElementById("input").addEventListener("keyup", function() {
    const searchTerm = this.value.toLowerCase();
    const table = document.querySelector("table");
    const rows = table.getElementsByTagName("tr");

    for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        let found = false;

        for (let j = 0; j < cells.length; j++) {
            if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                found = true;
                break;
            }
        }

        rows[i].style.display = found ? "" : "none";
    }
});

// Filter functionality
document.querySelectorAll(".filter-option").forEach((item) => {
    item.addEventListener("click", function() {
        const filterValue = this.getAttribute("data-filter").toLowerCase();
        document.getElementById("selected-filter").textContent = this.textContent;
        document.getElementById("filterDropdown").setAttribute("data-selected", filterValue);
        applyFilters();
    });
});

function applyFilters() {
    const filterValue = document.getElementById("filterDropdown").getAttribute("data-selected") || "all";
    const table = document.querySelector("table");
    const rows = table.getElementsByTagName("tr");

    for (let i = 1; i < rows.length; i++) {
        const statusCell = rows[i].cells[6]; // Status column
        const priorityCell = rows[i].cells[5]; // Priority column
        const departmentCell = rows[i].cells[4]; // Department column

        let showRow = true;

        if (filterValue !== "all") {
            if (["pending", "in progress", "completed"].includes(filterValue)) {
                showRow = statusCell.textContent.toLowerCase().includes(filterValue);
            } else if (["low", "medium", "high"].includes(filterValue)) {
                showRow = priorityCell.textContent.toLowerCase().includes(filterValue);
            } else {
                showRow = departmentCell.textContent.toLowerCase().includes(filterValue);
            }
        }

        rows[i].style.display = showRow ? "" : "none";
    }
}

// Load workers by department
function loadWorkersByDepartment(department, requestId) {
    if (!department) {
        document.getElementById('workerSelect' + requestId).innerHTML = '<option value="">Select a department first</option>';
        document.getElementById('workerStatus' + requestId).textContent = '';
        return;
    }
    
    fetch('/get-workers-by-department/' + department)
        .then(response => response.json())
        .then(data => {
            const workerSelect = document.getElementById('workerSelect' + requestId);
            const workerStatus = document.getElementById('workerStatus' + requestId);
            
            workerSelect.innerHTML = '<option value="">Select a worker</option>';
            
            if (data.workers && data.workers.length > 0) {
                data.workers.forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.id;
                    option.textContent = `${worker.username} (${worker.status})`;
                    option.dataset.status = worker.status;
                    option.dataset.assigned = worker.assigned_requests;
                    workerSelect.appendChild(option);
                });
                
                const availableWorkers = data.workers.filter(w => w.status === 'Available').length;
                workerStatus.textContent = `${availableWorkers} available workers out of ${data.workers.length}`;
                workerStatus.className = availableWorkers > 0 ? 'form-text text-success' : 'form-text text-danger';
            } else {
                workerSelect.innerHTML = '<option value="">No workers found in this department</option>';
                workerStatus.textContent = 'No workers available in this department';
                workerStatus.className = 'form-text text-danger';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('workerSelect' + requestId).innerHTML = '<option value="">Error loading workers</option>';
            document.getElementById('workerStatus' + requestId).textContent = 'Error loading workers';
            document.getElementById('workerStatus' + requestId).className = 'form-text text-danger';
        });
}

// Initialize department selection for each modal
document.addEventListener('DOMContentLoaded', function() {
    const assignModals = document.querySelectorAll('[id^="assignModal"]');
    assignModals.forEach(modal => {
        const modalId = modal.id.replace('assignModal', '');
        const departmentSelect = document.getElementById('departmentSelect' + modalId);
        if (departmentSelect && departmentSelect.value) {
            loadWorkersByDepartment(departmentSelect.value, modalId);
        }
    });
    
    // Handle add worker form submission
    const addWorkerForm = document.getElementById('addWorkerForm');
    if (addWorkerForm) {
        addWorkerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/add-worker', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    return response.text();
                }
            })
            .then(data => {
                if (data) {
                    alert('Error: ' + data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the worker.');
            });
        });
    }
});
</script>
{% endblock %}